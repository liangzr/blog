<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>å¦‚ä½•æŒ‰åŸé¡ºåºæ‰“å°å‡ºå¯¹è±¡çš„å±æ€§ï¼Ÿ | OVERLOADING</title>
  <meta name="author" content="Jory Liang">
  
  <meta name="description" content="æœ¬æ–‡ä»ä¸€ä¸ªé—®é¢˜å‡ºå‘ï¼Œç®€å•ä»‹ç»äº† V8 ä¸­å­˜å‚¨å¯¹è±¡å±æ€§çš„æ–¹å¼ï¼Œä»¥åŠå‘½åå±æ€§å’Œå…ƒç´ çš„åŒºåˆ«ã€‚å¹¶æ¢è®¨äº†ä¸€ç§æ‰“å°åŸåº JSON æ•°æ®é”®å€¼çš„ç®€å•å®ç°">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="å¦‚ä½•æŒ‰åŸé¡ºåºæ‰“å°å‡ºå¯¹è±¡çš„å±æ€§ï¼Ÿ">
  <meta property="og:site_name" content="OVERLOADING">

  
    <meta property="og:image" content>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?822020422769969dec75820ad85d1b63";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>
</html>
 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">OVERLOADING</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> å¦‚ä½•æŒ‰åŸé¡ºåºæ‰“å°å‡ºå¯¹è±¡çš„å±æ€§ï¼Ÿ</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> æœ¬æ–‡ä»ä¸€ä¸ªé—®é¢˜å‡ºå‘ï¼Œç®€å•ä»‹ç»äº† V8 ä¸­å­˜å‚¨å¯¹è±¡å±æ€§çš„æ–¹å¼ï¼Œä»¥åŠå‘½åå±æ€§å’Œå…ƒç´ çš„åŒºåˆ«ã€‚å¹¶æ¢è®¨äº†ä¸€ç§æ‰“å°åŸåº JSON æ•°æ®é”®å€¼çš„ç®€å•å®ç°
		 </div> <!-- alert -->
	  		

	  <p>æ˜¨å¤©åœ¨ç¾¤é‡Œçœ‹åˆ°æœ‰äººé—®:</p>
<blockquote>
<p>ç½‘å‹ï¼šâ€œ<strong>Object.keysä¼šç»™å€¼æ’åºï¼Œé‚£ç”¨å“ªä¸ªæ–¹æ³•å–å¯¹è±¡å±æ€§èƒ½ä¸æ’åºçš„ï¼Ÿ</strong>â€<br>æˆ‘ï¼šâ€œå¯¹è±¡çš„å±æ€§æœ‰é¡ºåºå—ï¼Ÿâ€<br>ç½‘å‹ï¼šâ€œè¿™ä¸ªå°±ä¼šæŒ‰ç…§ä»å°åˆ°å¤§æ’åºï¼Œæˆ‘åªæ˜¯æƒ³ä¿æŒåŸæ ·~~â€ (å¦‚ä¸‹)<br>æˆ‘ï¼šâ€forâ€¦in åº”è¯¥ä¸ä¼šâ€<br>â€¦â€¦</p>
</blockquote>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1g0wixmegiij30gk02vglu.jpg" alt></p>
<p>ç»“æœæˆ‘è¯•äº†ä¸‹å‘ç° <code>for..in</code> ä¹Ÿä¼šï¼Œæœ€ç»ˆæˆ‘è¯•äº†å…­ç§æ–¹æ³•ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="number">100</span>: <span class="string">'a'</span>, <span class="number">2</span>: <span class="string">'b'</span>, <span class="number">7</span>: <span class="string">'c'</span> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="built_in">Object</span>.keys(obj)                          <span class="comment">// ["2", "7", "100"]</span></span><br><span class="line"><span class="built_in">Object</span>.values(obj)                        <span class="comment">// ["b", "c", "a"]</span></span><br><span class="line"><span class="built_in">Object</span>.entries(obj)                       <span class="comment">// "2,b,7,c,100,a", toString() ä¹‹å</span></span><br><span class="line"><span class="keyword">for</span> (key <span class="keyword">in</span> obj) &#123; <span class="built_in">console</span>.log(key) &#125;     <span class="comment">// 2, 7, 10</span></span><br><span class="line"><span class="built_in">Object</span>.getOwnPropertyNames(obj)           <span class="comment">// ["2", "7", "100"]</span></span><br><span class="line"><span class="built_in">Reflect</span>.ownKeys(obj)                      <span class="comment">// ["2", "7", "100"]</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä»¥ä¸Šæ–¹æ³•éƒ½æ— ä¸€ä¾‹å¤–åœ°ä»¥ <code>{ 2: &#39;b&#39;, 7: &#39;c&#39;, 100: &#39;a&#39; }</code> çš„æ–¹å¼æ‰“å°å‡ºäº†ç›¸å…³å€¼ï¼Œé‚£è¿™ä¸ªé—®é¢˜çš„å½±å“åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
<a id="more"></a>
<p>å‡å¦‚ä½ ä»æ¥å£ä¸­è·å–ä¸€æ®µ JSON æ•°æ®å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"100"</span>: &#123; ... &#125;,</span><br><span class="line">  <span class="string">"2"</span>: &#123; ... &#125;,</span><br><span class="line">  <span class="string">"7"</span>: &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä¸ªæ•°æ®å¯èƒ½æ˜¯ç»è¿‡åç«¯æ’åºçš„ï¼Œå¹¶ä¸”æ•°æ®ä¸­å¹¶æ²¡æœ‰å¸¦æœ‰å¯ä¾›æ’åºçš„ä¿¡æ¯ï¼Œæ¯«æ— ç–‘é—®ç»è¿‡ JS çš„é‡æ–°æ’åºåï¼Œå®ƒçš„æ’åºä¿¡æ¯å°±ä¸¢å¤±äº†ï¼Œå‡å¦‚æˆ‘å°±æ˜¯ä¸æƒ³ä¸¢å¤±å‘¢ï¼Ÿ</p>
<p>æ¬²çŸ¥å…¶ç„¶ï¼Œå…ˆçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚åœ¨äº†è§£å®ƒå¦‚æœéå†å±æ€§ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œåœ¨ V8 ä¸­å¯¹è±¡æ˜¯å¦‚ä½•å­˜å‚¨å±æ€§çš„å‘¢ï¼Ÿ</p>
<h2 id="V8-ä¸­å¯¹è±¡çš„å±æ€§"><a href="#V8-ä¸­å¯¹è±¡çš„å±æ€§" class="headerlink" title="V8 ä¸­å¯¹è±¡çš„å±æ€§"></a>V8 ä¸­å¯¹è±¡çš„å±æ€§</h2><p>åœ¨ JavaScript ä¸­ï¼Œå¤§éƒ¨åˆ†æ—¶å€™å¯¹è±¡çš„è¡Œä¸ºç±»ä¼¼ä¸€ä¸ªå­—å…¸ï¼Œå®ƒä»¥å­—ç¬¦ä¸²åšä¸ºé”®åï¼Œä»¥ä»»æ„å¯¹è±¡ä½œä¸ºå€¼ã€‚è™½ç„¶åœ¨è¿­ä»£çš„æ—¶å€™ï¼Œè§„èŒƒçº¦å®šäº†ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†æ•´æ•°ç´¢å¼•å±æ€§å’Œå…¶ä»–å±æ€§ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å…ˆæ¥è§£é‡Šä¸‹æ•´æ•°ç´¢å¼•å±æ€§å’Œå‘½åå±æ€§çš„åŒºåˆ«ã€‚</p>
<h3 id="Named-properties-vs-elements"><a href="#Named-properties-vs-elements" class="headerlink" title="Named properties vs. elements"></a>Named properties vs. elements</h3><p>å…ˆæ¥å‡è®¾ä¸€ä¸ªç®€å•çš„å¯¹è±¡ <code>{a: &#39;foo&#39;, b: &#39;bar&#39;}</code>ã€‚è¯¥å¯¹è±¡æœ‰ä¸¤ä¸ªå‘½åå±æ€§,<code>a</code> å’Œ <code>b</code>ï¼Œå®ƒæ²¡æœ‰æ•´æ•°ç´¢å¼•ã€‚æ•´æ•°ç´¢å¼•å±æ€§ï¼ˆé€šå¸¸å«åšå…ƒç´ elementï¼‰åœ¨æ•°ç»„ä¸­æ¯”è¾ƒå¸¸è§ï¼Œå¦‚ <code>[&#39;foo&#39;, &#39;bar&#39;]</code> æœ‰ä¸¤ä¸ªæ•´æ•°ç´¢å¼•ï¼Œåˆ†åˆ«ä¸º 0 å’Œ 1ã€‚è¿™æ˜¯ V8 å¤„ç†å±æ€§çš„ç¬¬ä¸€ä¸ªä¸»è¦åŒºåˆ«ã€‚</p>
<p><img src="https://v8.dev/_img/fast-properties/jsobject.png" alt></p>
<p>å…ƒç´ å’Œå±æ€§å­˜å‚¨åœ¨ä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®ç»“æ„ä¸­ï¼Œè¿™ä½¿å¾—æ·»åŠ å’Œè®¿é—®å±æ€§æˆ–å…ƒç´ ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹éƒ½æ›´æœ‰æ•ˆç‡ã€‚</p>
<p>å…ƒç´ ä¸»è¦ç”¨äº <code>Array.prototype</code> çš„å„ç§æ–¹æ³•ï¼Œé‰´äºè¿™äº›å‡½æ•°è®¿é—®çš„æ˜¯è¿èŒƒå›´å†…çš„å±æ€§ï¼ŒV8 åœ¨å†…éƒ¨ä¹Ÿå°†ä»–ä»¬è¡¨ç¤ºä¸ºç®€å•æ•°ç»„ï¼ˆåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯è¿™æ ·çš„ï¼Œæœ‰æ—¶ä¼šåˆ‡æ¢åˆ°åŸºäºç¨€ç–å­—å…¸çš„å½¢å¼æ¥èŠ‚çœå†…å­˜ï¼‰</p>
<p>å‘½åå±æ€§ä»¥ç±»ä¼¼çš„æ–¹å¼å­˜å‚¨åœ¨å•ç‹¬çš„æ•°ç»„ä¸­ã€‚ä½†æ˜¯ä¸å…ƒç´ ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ç®€å•çš„é”®æ¥æ¨æ–­ä»–ä»¬åœ¨å±æ€§æ•°ç»„ä¸­çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›é¢å¤–çš„å…ƒæ•°æ®ã€‚åœ¨ V8 ä¸­ï¼Œæ¯ä¸ª JavaScript å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå…³è”çš„ HiddenClassï¼Œå®ƒç”¨æ¥å­˜å‚¨å¯¹è±¡çš„ç»“æ„ä¿¡æ¯ï¼Œä»¥åŠä»å±æ€§ååˆ°å±æ€§æ•°ç»„çš„ç´¢å¼•çš„ä¸€ä¸ªæ˜ å°„å…³ç³»ã€‚å¯¹äºå¤æ‚çš„æƒ…å†µï¼Œé€šå¸¸ä¼šä½¿ç”¨ä¸€ä¸ªå­—å…¸æ¥å­˜å‚¨å±æ€§ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç®€å•çš„æ•°ç»„ã€‚</p>
<blockquote>
<p>æ›´è¯¦ç»†çš„å†…å®¹è¯·é˜…è¯» V8 åšå®¢çš„æ–‡ç«  <a href="https://v8.dev/blog/fast-properties" target="_blank" rel="noopener">Fast properties in V8</a></p>
</blockquote>
<h2 id="å¦‚ä½•éå†å¯¹è±¡çš„å±æ€§"><a href="#å¦‚ä½•éå†å¯¹è±¡çš„å±æ€§" class="headerlink" title="å¦‚ä½•éå†å¯¹è±¡çš„å±æ€§"></a>å¦‚ä½•éå†å¯¹è±¡çš„å±æ€§</h2><p>é€šè¿‡æŸ¥è¯¢ ECMA 262 è§„èŒƒæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€èŠ‚ä¸­æˆ‘ä»¬ä½¿ç”¨çš„å…­ç§éå†å±æ€§çš„æ–¹æ³•ï¼Œåœ¨ç±»ä¼¼çš„æƒ…å†µä¸‹ï¼Œæœ€ç»ˆéƒ½ä¼šè¿”å› <code>Obj.[[OwnPropertyKeys]]</code> çš„ç»“æœã€‚</p>
<p>æŒ‰ç…§ ECMA 262 ä¸­å¯¹ <code>[[OwnPropertyKeys]]</code> çš„<a href="https://tc39.github.io/ecma262/#sec-ordinary-object-internal-methods-and-internal-slots-ownpropertykeys" target="_blank" rel="noopener">å®šä¹‰</a>ï¼š</p>
<blockquote>
<p>When the <code>[[OwnPropertyKeys]]</code> internal method of O is called, the following steps are taken:</p>
<ol>
<li>Return ! OrdinaryOwnPropertyKeys(O).</li>
</ol>
</blockquote>
<p>å®ƒè¿”å›äº†ä¸€ä¸ª <code>OrdinaryOwnPropertyKeys(O)</code> çš„å¤„ç†ç»“æœï¼Œè€Œ <code>OrdinaryOwnPropertyKeys(O)</code> çš„æ‰§è¡Œè¿‡ç¨‹åˆ™æ˜¯ï¼š</p>
<blockquote>
<p>When the abstract operation OrdinaryOwnPropertyKeys is called with Object O, the following steps are taken:</p>
<ol>
<li>Let <code>keys</code> be a new empty List.</li>
<li>For each own property key <code>P</code> of <code>O</code> that is an array index, in ascending numeric index order, do<br>a. Add <code>P</code> as the last element of <code>keys</code>.</li>
<li>For each own property key <code>P</code> of <code>O</code> that is a String but is not an array index, in ascending chronological order of property creation, do<br>a. Add <code>P</code> as the last element of <code>keys</code>.</li>
<li>For each own property key <code>P</code> of <code>O</code> that is a Symbol, in ascending chronological order of property creation, do<br>b. Add P as the last element of <code>keys</code>.</li>
<li>Return <code>keys</code>.</li>
</ol>
</blockquote>
<p>æˆ‘ä»¬æ¥ç®€å•æè¿°ä¸‹ä¸Šè¿°è¿‡ç¨‹å°±æ˜¯ï¼šé¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º <code>keys</code> çš„ç©ºæ•°ç»„ï¼Œç„¶åå…ˆéå†å¯¹è±¡ä¸­çš„æ•°ç»„ç´¢å¼•çš„å±æ€§ï¼Œç»“æœä»¥å‡åºæ’åˆ—ï¼Œå¹¶é€ä¸ªæ”¾å…¥ <code>keys</code> ä¸­ï¼›å†éå†å­—ç¬¦ä¸²å±æ€§ï¼ˆä½†ä¸æ˜¯æ•°ç»„ç´¢å¼•ï¼‰ï¼Œä»¥å±æ€§åˆ›å»ºæ—¶é—´å‡åºæ’åˆ—ï¼Œå¹¶é€ä¸ªæ”¾å…¥ <code>keys</code> ä¸­å»ï¼›ç„¶åå†éå† Symbol ç±»å‹çš„å±æ€§åï¼ŒåŒæ ·ä»¥å±æ€§åˆ›å»ºæ—¶é—´å‡åºæ’åˆ—ï¼Œæ”¾å…¥ <code>keys</code> ä¸­ï¼Œæœ€åè¿”å› <code>keys</code> æ•°ç»„ã€‚</p>
<p>ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123;</span><br><span class="line">  b: <span class="number">1</span>,</span><br><span class="line">  a: <span class="number">2</span>,</span><br><span class="line">  c: <span class="number">3</span>,</span><br><span class="line">  <span class="number">7</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="number">1</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="number">10</span>: <span class="number">6</span>,</span><br><span class="line">  [<span class="built_in">Symbol</span>(<span class="string">'a'</span>)]: <span class="number">7</span></span><br><span class="line">&#125;</span><br><span class="line">a.d = <span class="number">8</span></span><br><span class="line">a[<span class="built_in">Symbol</span>(<span class="string">'b'</span>)] = <span class="number">9</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Reflect</span>.ownKeys(a)</span><br></pre></td></tr></table></figure>
<p>output(devtools):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">9</span>) [<span class="string">"1"</span>, <span class="string">"7"</span>, <span class="string">"10"</span>, <span class="string">"b"</span>, <span class="string">"a"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="built_in">Symbol</span>(a), <span class="built_in">Symbol</span>(b)]</span><br><span class="line">  <span class="number">0</span>: <span class="string">"1"</span></span><br><span class="line">  <span class="number">1</span>: <span class="string">"7"</span></span><br><span class="line">  <span class="number">2</span>: <span class="string">"10"</span></span><br><span class="line">  <span class="number">3</span>: <span class="string">"b"</span></span><br><span class="line">  <span class="number">4</span>: <span class="string">"a"</span></span><br><span class="line">  <span class="number">5</span>: <span class="string">"c"</span></span><br><span class="line">  <span class="number">6</span>: <span class="string">"d"</span></span><br><span class="line">  <span class="number">7</span>: <span class="built_in">Symbol</span>(a)</span><br><span class="line">  <span class="number">8</span>: <span class="built_in">Symbol</span>(b)</span><br><span class="line">  length: <span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>Chrome çš„å®ç°ä¸è§„èŒƒçš„çº¦å®šå®Œå…¨ä¸€è‡´ğŸ˜•ï¼Œæ‰€ä»¥è‡³æ­¤æˆ‘ä»¬çŸ¥é“å®ƒä¸ºä»€ä¹ˆæ‰“å°å‡ºæ¥æ˜¯å‡åºçš„äº†ã€‚</p>
<p>å¦å¤–å¼•ç”¨ Chromium ç¤¾åŒºä¸Š <a href="https://bugs.chromium.org/p/v8/issues/detail?id=164" target="_blank" rel="noopener">Issue 164: Wrong order in Object properties interation</a> çš„è®¨è®ºæ‰€è¿°ï¼š</p>
<blockquote>
<p>There seems to be a widespread feeling that this used to work the way people expected it, but then the V8 team broke it in order to be mean.</p>
<p>What actually happened was that originally the order was completely arbitrary in V8.  At a later point it was changed so that non-numeric indices were in insertion order, and numeric indices were sometimes in insertion order.  Whether or not the numeric indices were in in insertion order was dependent on internal V8 heuristics that decide whether to use an array or a hash map implementation for the numeric indices.  Making heuristics in the V8 implementation visible in this way was felt to be undesirable so it was normalized so that numeric indices were always iterated in numeric order regardless of the internal representation.  Numeric iteration order was always a possibility, but with the last change it was made predictable.</p>
<p>There has never been any difference between the internal representation or iteration order of arrays vs. other objects in V8.</p>
<p>Here is an independent test of the way arrays and objects perform in various engines (a little out of date now): <a href="http://news.qooxdoo.org/javascript-array-performance-oddities-characteristics" target="_blank" rel="noopener">http://news.qooxdoo.org/javascript-array-performance-oddities-characteristics</a>  If this bug ever gets â€˜fixedâ€™ you can wave goodbye to some of the nice performance results in that graph.</p>
</blockquote>
<p>ç»“åˆå‰é¢ä»‹ç»çš„ V8 å±æ€§ä¸€èŠ‚æˆ‘ä»¬çŸ¥é“ï¼Œæ•°ç»„å±æ€§æ€»æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªå•ç‹¬çš„ç©ºé—´ï¼ˆå¯èƒ½æ˜¯æ•°ç»„ï¼Œä¹Ÿå¯èƒ½æ˜¯å­—å…¸ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå§‹ç»ˆä»¥æœ‰åºæ•°ç»„çš„çŠ¶æ€è¾“å‡ºé”®å€¼ï¼Œè¿™æ ·çš„ç»“æœæ˜¯å¯é¢„æµ‹çš„ï¼ˆå§‹ç»ˆä¸€è‡´ï¼‰ã€‚å¹¶ä¸”åœ¨ V8 å†…éƒ¨ï¼Œæ•°ç»„çš„å†…éƒ¨è¡¨ç¤ºå’Œè¿­ä»£æ–¹å¼ï¼Œå’Œå…¶å®ƒå¯¹è±¡æ²¡æœ‰ä»»ä½•ä¸åŒã€‚</p>
<p>ç»¼ä¸Šæ‰€è®²ï¼Œè¿™æ ·çš„å†…éƒ¨å®ç°ï¼Œæœ‰æ€§èƒ½çš„å› ç´ ï¼Œä¹Ÿæœ‰å†å²åŸå› ã€‚</p>
<h2 id="æœ‰æ²¡æœ‰åŠæ³•æŒ‰åŸé¡ºåºæ‰“å°ï¼Ÿ"><a href="#æœ‰æ²¡æœ‰åŠæ³•æŒ‰åŸé¡ºåºæ‰“å°ï¼Ÿ" class="headerlink" title="æœ‰æ²¡æœ‰åŠæ³•æŒ‰åŸé¡ºåºæ‰“å°ï¼Ÿ"></a>æœ‰æ²¡æœ‰åŠæ³•æŒ‰åŸé¡ºåºæ‰“å°ï¼Ÿ</h2><p>è®²äº†é‚£ä¹ˆå¤šï¼Œæˆ‘å°±æ˜¯æƒ³æŒ‰åŸé¡ºåºæ‰“å°æ€ä¹ˆåŠï¼Ÿ</p>
<p>é¦–å…ˆå¦‚æœç›®æ ‡ç»“æ„å·²ç»æ˜¯ JavaScript å¯¹è±¡ï¼Œåº”è¯¥æ˜¯æ²¡æœ‰åŠæ³•äº†ã€‚æˆ‘ä»¬å›åˆ°æœ€ç»ˆçš„é—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸² JSON æ•°ç»„ï¼Œæƒ³æŠŠå®ƒæŒ‰åŸåºè·å¾—é”®å€¼ï¼Œå¯ä»¥æ€ä¹ˆåšï¼Ÿå‡å¦‚æˆ‘ä»¬æœ‰ä¸²æ•°æ®ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"100"</span>:<span class="string">"foo"</span>,<span class="attr">"2"</span>:<span class="string">"bar"</span>,<span class="attr">"7"</span>:<span class="string">"baz"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆèƒ½æƒ³åˆ°çš„ä¸€ä¸ªç®€å•çš„æ–¹æ³•å°±æ˜¯ï¼Œè‡ªå·±å†™ä¸€ä¸ªç®€å•çš„ json-parserã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jsonString = <span class="string">'&#123;"100":"foo","2":"bar","7":"baz"&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> parseKeys = <span class="function"><span class="params">str</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> out = []</span><br><span class="line">  <span class="keyword">const</span> tokens = str.slice(<span class="number">1</span>, <span class="number">-1</span>).split(<span class="string">','</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tokens.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">    out.push(tokens[i].split(<span class="string">':'</span>)[<span class="number">0</span>].slice(<span class="number">1</span>, <span class="number">-1</span>))  </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">return</span> out</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// try</span></span><br><span class="line"><span class="built_in">console</span>.log(parseKeys(jsonString))  <span class="comment">// âœ… ["100", "2", "7"]</span></span><br></pre></td></tr></table></figure>
<p>çœ‹èµ·æ¥æˆ‘ä»¬å¾—åˆ°äº†æƒ³è¦çš„ç»“æœï¼ˆyeahï¼‰ï¼Œä½†æ˜¯å¦‚æœ json æ•°ç»„ç¨å¾®å¤æ‚ç‚¹å„¿å‘¢ï¼Ÿ</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"100"</span>:&#123;<span class="attr">"b"</span>:<span class="string">"foo"</span>&#125;,<span class="attr">"2"</span>:[<span class="number">1</span>,<span class="number">2</span>],<span class="attr">"7"</span>:<span class="number">200</span>&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†æ¥é‡æ„ä¸‹è¿™ä¸ªè§£æå™¨ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> parseKeys = <span class="function">(<span class="params">str, lvl = <span class="number">1</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> out = []</span><br><span class="line">  <span class="keyword">let</span> level = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> matching = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> pair = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (str.charAt(i) === <span class="string">'"'</span> &amp;&amp; level === lvl) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!matching) &#123;</span><br><span class="line">        pair[<span class="number">0</span>] = i </span><br><span class="line">      &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">        pair[<span class="number">1</span>] = i</span><br><span class="line">        out.push([...pair])</span><br><span class="line">      &#125;</span><br><span class="line">      matching = ~matching</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="string">'&#123;'</span>, <span class="string">'['</span>].indexOf(str.charAt(i) &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">      level += <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="string">'&#125;'</span>, <span class="string">']'</span>].indexOf(str.charAt(i) &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">      level -= <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> out.map(<span class="function"><span class="params">pair</span> =&gt;</span> str.slice(pair[<span class="number">0</span>], pair[<span class="number">1</span>]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>output(devtools):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">"100"</span>, <span class="string">"2"</span>, <span class="string">"7"</span>]</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ªæ–¹æ³•æ‰§è¡Œæ•ˆç‡å¹¶ä¸é«˜ï¼Œåªæ˜¯æå‡ºä¸€ç§æ€è·¯ï¼Œå½“ç„¶æˆ‘ä»¬çš„ç›®æ ‡è¿˜æ˜¯è§£æå‡º keyï¼Œè€Œä¸æ˜¯å®Œæ•´çš„å¼•å…¥ä¸€ä¸ª json è§£é‡Šå™¨ï¼Œé‚£æ ·å¯èƒ½å¾—ä¸å¿å¤±ã€‚</p>
<p>æ›´é«˜æ•ˆçš„è§£å†³æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹‹åå†è¡¥å……â€¦</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR;"></a>TL; DR;</h2><p>V8 åœ¨å†…éƒ¨å°†å‘½åå±æ€§å’Œæ•°ç»„ç´¢å¼•å±æ€§åˆ†å¼€å­˜å‚¨ï¼Œå¹¶ä¸”æ•°ç»„å’Œå…¶å®ƒå¯¹è±¡çš„å†…éƒ¨å®ç°å’Œè¿­ä»£æœºåˆ¶æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p>
<p>ç”±è§„èŒƒå®šä¹‰ï¼Œå¯¹è±¡åœ¨è¿­ä»£çš„æ—¶å€™ï¼Œæ€»æ˜¯ä»¥å‡åºè¾“å‡ºæ•°ç»„ç´¢å¼•çš„å±æ€§ã€‚å¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç›®å‰å¯èƒ½è‡ªå·±å»è§£æ JSON å­—ç¬¦ä¸²ã€‚</p>
<p>æ›´å¤šé—®é¢˜çš„å»¶ä¼¸è®¨è®ºï¼Œè¯·å‚è€ƒ Chromium ç¤¾åŒºçš„ <strong>Issue: 164</strong> è®¨è®ºã€‚</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://tc39.github.io/ecma262/#sec-ordinary-object-internal-methods-and-internal-slots-ownpropertykeys" target="_blank" rel="noopener">ECMA262 Specification - OwnPropertyKeys</a></li>
<li><a href="https://v8.dev/blog/fast-properties" target="_blank" rel="noopener">Fast properties in V8</a></li>
<li><a href="https://v8.dev/blog/fast-for-in" target="_blank" rel="noopener">Fast for-in in V8</a></li>
<li><a href="https://bugs.chromium.org/p/v8/issues/detail?id=164" target="_blank" rel="noopener">Issue 164: Wrong order in Object properties interation</a></li>
</ul>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2018/12/30/fork__why_do_we_write_super/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">Comments</h2>

    
    <div id="disqus_thread" class="ds-thread">
        <script type="text/javascript">
            /**
             * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
                /*
                 var disqus_config = function () {
                 this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                 this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                 };
                 */
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = '//liangzr.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
    </div>
    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2019-03-09 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/javascript/">javascript<span>1</span></a></li> <li><a href="/tags/v8/">v8<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#V8-ä¸­å¯¹è±¡çš„å±æ€§"><span class="toc-article-text">V8 ä¸­å¯¹è±¡çš„å±æ€§</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Named-properties-vs-elements"><span class="toc-article-text">Named properties vs. elements</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#å¦‚ä½•éå†å¯¹è±¡çš„å±æ€§"><span class="toc-article-text">å¦‚ä½•éå†å¯¹è±¡çš„å±æ€§</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#æœ‰æ²¡æœ‰åŠæ³•æŒ‰åŸé¡ºåºæ‰“å°ï¼Ÿ"><span class="toc-article-text">æœ‰æ²¡æœ‰åŠæ³•æŒ‰åŸé¡ºåºæ‰“å°ï¼Ÿ</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#TL-DR"><span class="toc-article-text">TL; DR;</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Reference"><span class="toc-article-text">Reference</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->

<script type="text/javascript">
var disqus_shortname = 'liangzr';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2019 Jory Liang
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>â¬†ï¸TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
